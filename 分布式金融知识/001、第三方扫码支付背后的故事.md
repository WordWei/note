### 扫码支付：

#### 鉴权 

扫码支付最终会用买家的银行卡进行支付。在你开始扫码支付之前，第三方公司需要核实你是否有这张卡的使用权，俗称“**绑卡**”。 我们一般采用下面这 4 个要素来进行验证： 

1.  用户姓名 
2.  用户身份证号码 
3.  银行卡号码 
4.  银行注册的手机号 

绑卡在第三方APP上进行绑定操作，但信息的核验是在银行进行校验， 所以为了进一步增强安全性，银行在验证手机号码的时候还需要验证你是否拥有这个**手机号码**。具体的方式是发一条验证码给在你在银行柜台办借记卡时注册的手机号码。 

可以把鉴权分为4个步骤：

1.  用户填写前 3 个要素和手机号码； 
2.  银行发短信验证码给用户手机号； 
3.  用户将前 3 个要素和短信验证码发给第三方支付公司； 
4.  第三方支付公司再将所有信息发送给银行进行确认。 

 鉴权的过程其实是验证了 5 个信息，其中 4 个是静态信息，1 个是动态信息 。 **在用户绑卡通过之后，银行会返回给第三方支付公司这个用户的内部 ID 信息（也叫 Token）**。之后第三方支付公司就可以拿这个 ID 进行所有合法的操作。 

鉴权流程图如下：

![扫码支付鉴权流程图](C:\Users\Administrator\Desktop\技术积累\photo\鉴权.png)

#### 支付

鉴权完成后，进行扫码支付， 二维码是一个图形化的字符串，背后是这笔交易对应的订单。当用户点击“确认”之后，就会开始整个支付流程。 

#### 拉取支付状态 

为什么拉取？

 用户 App 的支付确认按钮是有局限的，它只能确认后台是否已经收到了支付请求，并不能确认支付是否已经成功。  支付后台需要花一些时间和银行沟通， 用户 App 需要每隔一段时间就向支付后台拉取交易情况，我们通常会把这个过程叫作**轮询**。这个过程一般在几百毫秒内就能结束。 

#####  异步消息处理 

 金融机构每天会面对大量的用户资金操作，这些操作的时间和频率有很大的偶然性。  为了应对用户操作的峰值情况，金融机构普遍通过**异步消息处理**的架构来对极端流量进行削峰填谷。 如果流量突然增大，异步消息架构会缓存所有请求，慢慢处理。这样就能避免核心金融系统超载。异步消息架构的结果就是用户不会及时得到处理结果，需要自己不断地去查询处理情况。  

##### 推拉结合

 当银行处理完支付后，银行会把支付成功的消息推送给用户和第三方支付公司。第三方支付公司也会推送给你支付成功的消息。 

 两种不同的获取最新状态的方式。一种是用户定期去拉取状态，另一种是服务器将状态消息实时推送给用户。这种**推拉结合**的消息通知方式，其实是架构设计中常见的异步系统处理方式。 

![](C:\Users\Administrator\Desktop\技术积累\photo\推拉结合.jpg)

####  **第三方公司进行本币代收** 

 本币代收，就是第三方支付公司代收用户资金。本币代收就是将你该付的钱先打到第三方支付公司账上。 当买家的银行卡与第三方支付公司的账号属于不同的银行时，本币代收就需要进行跨行转账。这里介绍一些金融银行的基本概念，方便理解。

#####  央行 

 跨行转账的时候，钱是在不同的银行。 怎么转？转多少金额？

跨行搬钱？汽车？火车？太low，容易出事。

这时候又需要另一个第三方机构出马了。所有银行都在这个新的第三方机构里放足够多的钱，一般叫做**存款准备金**。当两家银行之间需要转账的时候，第三方机构在**内部**搬运一下就好。比如美国的黄金交易所就是这种工作模式，每个客户都有自己专属的黄金仓库，很多小车在仓库之间搬运黄金。若第三方机构足够可信， 只需要记录一下谁的钱有多少，以及从哪里搬了多少到另一个地方就行。 信用级别最高的金融机构就是国家的中央银行，简称**央行。所以央行解决了真实资金的转移问题。** 

##### 清算机构 

那么**央行**怎么知道转移的金额有多少。会有这个问题的原因是每天银行之间的跨行交易非常多，不可能每一笔都通过央行转一次钱。所以银行系统对跨行转账的流程进行了优化。那就是在**白天只做记录**，不进行任何实质性的跨行转账。等每天结束的时候计算一下两个银行之间交易金额的差额是多少，最后通过**央行进行一笔跨行转账**就可以了。这种计算交易差额的方式叫做**轧差**。 

这个记录白天跨行转账细节和晚上进行交易轧差的第三方机构叫作清算机构。你熟悉的**银联**及**网联**，以及国外的**万事达**，它们都是清算机构。 

在介绍拉取支付状态的时候，讲过金融系统采用异步消息处理架构应对支付流量。轧差是另一种金融机构应对大流量的一种处理方式。**轧差的本质是实时消息的批量处理**，从某种程度来讲是延时更大的异步处理框架。

##### 跨行转账流程

第一步 ： 第三方支付公司发送指令给**第三方开户行**，要求将钱从用户的**买家开户行**转到**第三方开户行。** 

第二步 ： 第三方支付公司拥有用户在**买家开户行**的 Token，所以可以合法发起这笔转账。跨行转账流程开始。 

第三步 ： **第三方开户行**将所有信息交给清算机构。**清算机构**作为第三方负责记录这些信息，并通知**买家开户行**和**第三方开户行**记录这笔转账。 

第四步 ： **买家开户行**记录的结果是对用户的账号进行扣款。扣款结束后用短信的方式通知用户。 

第五步 ： **第三方开户行**记录的结果是对第三方支付公司的账号进行打款。打款结束后第三方支付公司可以通过银行网页看到对公账户金额发生变化。白天的工作到此结束。此时**买家开户行**的账面上的资金虽然减少，但是减少的钱并没有实质性到达**第三方开户行**。 

第六步 ： 到了晚上，**清算机构**对白天发生的交易进行盘存，发现有一笔从**买家开户行**到**第三方开户行**的跨行转账还没有真正完成。**清算机构**会将这笔未完成的跨行转账信息发送给**央行**。 

第七步 ： **央行**收到信息之后，将**买家开户行**在央行的存款准备金调低，并将**第三方开户行**在央行的存款准备金调高。这样钱就真正地从**买家开户行**转到了**第三方开户行**。 

整体流程图如下：

![](C:\Users\Administrator\Desktop\技术积累\photo\跨行转账.png)

### 注意

 		二维码支付涉及的大多数环节都是**异步系统**，比如用户 App 的异步支付状态查询，以及清算中心和央行及银行之间的跨行转账清结算过程。异步系统不会将结果同步返回给调用方。因此，我们在设计系统的时候，**就需要支持状态的查询以及状态消息的推送功能。** 













